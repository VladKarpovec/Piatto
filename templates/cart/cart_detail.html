{% extends "base.html" %}

{% block title %}Кошик{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">Ваш кошик</h2>

    {% if cart|length %}
        <form id="cart-form" method="post" action="{% url 'cart:update_cart' %}">
            {% csrf_token %}
            <table class="table">
                  <thead>
                    <tr>
                      <th>Страва</th>
                      <th>Кількість</th>
                      <th>Ціна за шт.</th>
                      <th>Сума</th>
                      <th>Дії</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in cart %}
                    <tr data-id="{{ item.dish.id }}">
                      <td>{{ item.dish.name }}</td>
                      <td>
                        <input type="number" min="0" class="form-control quantity-input" name="quantity-{{ item.dish.id }}" value="{{ item.quantity }}" style="width:90px;" />
                      </td>
                      <td class="unit-price">{{ item.price }}</td>
                      <td class="item-total">{{ item.total_price }}</td>
                      <td>
                        <button type="button" class="btn btn-danger btn-sm btn-remove" data-id="{{ item.dish.id }}">Видалити</button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>


            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4>Загальна сума: <span id="cart-total">{{ total }}</span> грн</h4>
                <div>
                    <button type="submit" class="btn btn-primary me-2">Оновити кошик</button>
                    <button type="button" id="clear-cart" class="btn btn-warning">Очистити кошик</button>
                </div>
            </div>
        </form>

        <form id="proceed-form" method="post" action="{% url 'cart:proceed_to_order' %}" class="mt-3 text-end">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Оформити замовлення</button>
        </form>
    {% else %}
        <p>Кошик порожній.</p>
        <a href="{% url 'menu:category_list' %}" class="btn btn-primary mt-3">Повернутись до меню</a>
    {% endif %}
</div>

<script>
(function(){
  function getCsrf(){
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  // оновлення при зміні кількості (робимо AJAX-запит на update_cart)
  document.querySelectorAll('.quantity-input').forEach(function(input){
    input.addEventListener('change', function(){
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCsrf());
      formData.append(this.name, this.value);

      fetch("{% url 'cart:update_cart' %}", {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: formData
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          // оновимо суму та конкретний рядок
          const id = this.name.split('-')[1];
          const row = document.querySelector('tr[data-id="'+id+'"]');
          if(row){
            const item = data.updated_items[id];
            row.querySelector('.item-total').textContent = item.item_total;
          }
          document.getElementById('cart-total').textContent = data.total;
        }
      }).catch(console.error);
    });
  });

  // Видалення позиції
  document.querySelectorAll('.btn-remove').forEach(function(btn){
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCsrf());

      fetch(`{% url 'cart:remove_from_cart' 0 %}`.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: formData
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          const row = document.querySelector('tr[data-id="'+id+'"]');
          if(row) row.remove();
          document.getElementById('cart-total').textContent = data.total;
        }
      }).catch(console.error);
    });
  });

  // Очистити кошик
  const clearBtn = document.getElementById('clear-cart');
  if(clearBtn){
    clearBtn.addEventListener('click', function(){
      if(!confirm('Ви впевнені, що хочете очистити кошик?')) return;
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCsrf());
      fetch("{% url 'cart:clear_cart' %}", {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: formData
      }).then(r=>r.json()).then(data=>{
        if(data.success){
          // перезавантажимо сторінку або очистимо таблицю
          window.location.reload();
        }
      }).catch(console.error);
    });
  }
})();
</script>
{% endblock %}
