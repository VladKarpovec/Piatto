{% extends "base.html" %}

{% block title %}Кошик{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="section-title mb-4">Ваш кошик</h2>

    {% if cart|length %}
    <form id="cart-form" method="post" action="{% url 'cart:update_cart' %}">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-hover align-middle text-center mb-0" style="table-layout: fixed; width: 100%;">
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                </colgroup>
                <thead class="table-light">
                    <tr>
                        <th>Страва</th>
                        <th>Кількість</th>
                        <th>Ціна за шт.</th>
                        <th>Сума</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart %}
                    <tr data-id="{{ item.dish.id }}">
                        <td class="text-truncate" style="max-width: 300px;">{{ item.dish.name }}</td>
                        <td>
                            <input type="number" min="0" class="form-control form-control-sm quantity-input text-center"
                                   name="quantity-{{ item.dish.id }}" value="{{ item.quantity }}"
                                   style="width:70px; margin:0 auto;">
                        </td>
                        <td class="unit-price">{{ item.price|floatformat:2 }} грн</td>
                        <td class="item-total fw-semibold">{{ item.total_price|floatformat:2 }} грн</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-remove" data-id="{{ item.dish.id }}">
                                Видалити
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center border-top pt-3 mt-3">
            <h4>Загальна сума: <span id="cart-total">{{ total|floatformat:2 }}</span> грн</h4>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Оновити кошик</button>
                <button type="button" id="clear-cart" class="btn btn-warning">Очистити кошик</button>
            </div>
        </div>
    </form>

    <form id="proceed-form" method="post" action="{% url 'cart:proceed_to_order' %}" class="mt-4 text-end">
        {% csrf_token %}
        <button type="submit" class="btn btn-success btn-lg">Оформити замовлення</button>
    </form>
    {% else %}
    <p>Кошик порожній.</p>
    <a href="{% url 'menu:category_list' %}" class="btn btn-primary mt-3">Повернутись до меню</a>
    {% endif %}
</div>

<script>
(function(){
    function getCsrf(){ return document.querySelector('[name=csrfmiddlewaretoken]').value; }
    function formatPrice(value){ return (Math.round(value * 100) / 100).toFixed(2); }

    document.querySelectorAll('.quantity-input').forEach(function(input){
        input.addEventListener('change', function(){
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCsrf());
            formData.append(this.name, this.value);

            fetch("{% url 'cart:update_cart' %}", {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if(data.success){
                    const id = this.name.split('-')[1];
                    const row = document.querySelector('tr[data-id="'+id+'"]');
                    if(row && data.updated_items[id]){
                        const totalEl = row.querySelector('.item-total');
                        totalEl.style.transition = 'opacity 0.2s';
                        totalEl.style.opacity = '0';
                        setTimeout(() => {
                            totalEl.textContent = formatPrice(data.updated_items[id].item_total) + ' грн';
                            totalEl.style.opacity = '1';
                        }, 200);
                    }
                    document.getElementById('cart-total').textContent = formatPrice(data.total);
                }
            })
            .catch(console.error);
        });
    });

    document.querySelectorAll('.btn-remove').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCsrf());
            fetch(`{% url 'cart:remove_from_cart' 0 %}`.replace('/0/', `/${id}/`), {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if(data.success){
                    const row = document.querySelector('tr[data-id="'+id+'"]');
                    if(row){
                        row.style.transition = 'opacity 0.3s ease';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                    document.getElementById('cart-total').textContent = formatPrice(data.total);
                }
            })
            .catch(console.error);
        });
    });

    document.getElementById('clear-cart')?.addEventListener('click', function(){
        if(!confirm('Ви впевнені, що хочете очистити кошик?')) return;
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCsrf());
        fetch("{% url 'cart:clear_cart' %}", {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(r=>r.json())
        .then(data=>{
            if(data.success) window.location.reload();
        })
        .catch(console.error);
    });
})();
</script>
{% endblock %}
